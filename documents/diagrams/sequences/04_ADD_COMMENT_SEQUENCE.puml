@startuml
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

title Add Comment - Sequence Diagram\n4in1 Video Sharing Application

actor "User" as User
participant "Vue Component\n(CommentSection)" as Vue
participant "useComment\n(Composable)" as Composable
participant "CommentService" as CommentFactory
participant "JavaCommentService" as CommentService
participant "apiClient\n(Axios)" as Axios
participant "CommentAPI\n(Servlet)" as API
participant "CommentServiceImpl" as Service
participant "CommentRepo" as Repo
participant "UserRepo" as UserRepo
participant "VideoRepo" as VideoRepo
database "Database" as DB

== Add Comment Flow ==

User -> Vue : Nhap noi dung comment\nClick "Gui"
activate Vue

Vue -> Vue : Check user logged in\n(from localStorage)

alt User Not Logged In
    Vue --> User : Hien thi "Vui long dang nhap"
else User Logged In
    Vue -> Composable : addComment(content)
    activate Composable
    
    Composable -> Composable : Set submitting = true
    
    Composable -> CommentFactory : create(commentData)
    activate CommentFactory
    
    note right of CommentFactory
        commentData = {
            user: { id: userId },
            video: { id: videoId },
            content: "Nice video!"
        }
    end note
    
    CommentFactory -> CommentService : create(data)
    activate CommentService
    
    CommentService -> Axios : POST /api/comments\n{user, video, content}
    activate Axios
    
    note right of Axios
        Headers:
        Authorization: Bearer {token}
        Content-Type: application/json
    end note
    
    Axios -> API : HTTP POST Request
    activate API
    
    API -> API : parseRequestBody()\nCommentRequest.class
    
    API -> Service : create(CommentRequest)
    activate Service
    
    Service -> Service : Validate input\n- content not empty\n- userId required\n- videoId required
    
    alt Validation Failed
        Service --> API : throw AppException(INVALID_INPUT)
        API --> Axios : 400 Bad Request
        Axios --> CommentService : Error
        CommentService --> CommentFactory : {success: false}
        CommentFactory --> Composable : {success: false, error}
        Composable --> Vue : Error
        Vue --> User : Hien thi loi
    else Validation Passed
        Service -> UserRepo : findById(userId)
        activate UserRepo
        UserRepo -> DB : SELECT * FROM User WHERE id = ?
        DB --> UserRepo : User
        UserRepo --> Service : User entity
        deactivate UserRepo
        
        Service -> VideoRepo : findById(videoId)
        activate VideoRepo
        VideoRepo -> DB : SELECT * FROM Video WHERE id = ?
        DB --> VideoRepo : Video
        VideoRepo --> Service : Video entity
        deactivate VideoRepo
        
        alt User or Video Not Found
            Service --> API : throw AppException(NOT_FOUND)
            API --> Axios : 404 Not Found
            Axios --> CommentService : Error
            CommentService --> CommentFactory : {success: false}
            CommentFactory --> Composable : {success: false}
            Composable --> Vue : Error
            Vue --> User : Hien thi "Khong tim thay user/video"
        else All Valid
            Service -> Service : Create Comment entity\n- Set user, video, content\n- Set createdDate = now()\n- Set updatedDate = now()
            
            Service -> Repo : save(comment)
            activate Repo
            Repo -> DB : INSERT INTO Comment\n(userId, videoId, content, createdDate, updatedDate)\nVALUES (?, ?, ?, ?, ?)
            activate DB
            DB --> Repo : Generated ID
            deactivate DB
            Repo --> Service : Comment with ID
            deactivate Repo
            
            Service -> Service : Convert to CommentResponse\n{id, userId, videoId, content, createdDate, updatedDate}
            
            Service --> API : CommentResponse
            deactivate Service
            
            API --> Axios : 201 Created\n{success: true, data: comment}
            deactivate API
            
            Axios --> CommentService : Response
            deactivate Axios
            
            CommentService --> CommentFactory : {success: true, data: comment}
            deactivate CommentService
            
            CommentFactory --> Composable : {success: true, data: comment}
            deactivate CommentFactory
            
            Composable -> Composable : Add comment to comments array\nSet submitting = false
            Composable --> Vue : Success
            deactivate Composable
            
            Vue -> Vue : Clear input field\nUpdate comments list
            Vue --> User : Hien thi comment moi
        end
    end
end

deactivate Vue

@enduml
