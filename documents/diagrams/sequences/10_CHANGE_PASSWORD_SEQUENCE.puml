@startuml
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

title Change Password - Sequence Diagram\n4in1 Video Sharing Application

actor "User" as User
participant "Vue Component\n(AccountPage)" as Vue
participant "AuthService\n(Factory)" as AuthFactory
participant "JavaAuthService" as AuthService
participant "apiClient\n(Axios)" as Axios
participant "AuthAPI\n(Servlet)" as API
participant "AuthServiceImpl" as Service
participant "UserRepo" as Repo
database "Database" as DB

== Change Password Flow ==

User -> Vue : Nhap mat khau cu\nNhap mat khau moi\nXac nhan mat khau moi\nClick "Doi mat khau"
activate Vue

Vue -> Vue : Validate form\n- Old password required\n- New password min 6 chars\n- Confirm password match

alt Validation Failed
    Vue --> User : Hien thi loi validation
else Validation Passed
    Vue -> AuthFactory : changePassword(oldPassword, newPassword, confirmPassword)
    activate AuthFactory
    
    AuthFactory -> AuthService : changePassword(data)
    activate AuthService
    
    AuthService -> Axios : POST /api/auth/change-password\n{oldPassword, newPassword, confirmPassword}
    activate Axios
    
    note right of Axios
        Headers:
        Authorization: Bearer {token}
        Content-Type: application/json
    end note
    
    Axios -> API : HTTP POST Request
    activate API
    
    API -> API : Extract token from header
    API -> Service : validateToken(token)
    activate Service
    Service --> API : userId
    deactivate Service
    
    alt Token Invalid
        API --> Axios : 401 Unauthorized\n{success: false, message: "Token khong hop le"}
        Axios --> AuthService : Error
        AuthService --> AuthFactory : {success: false}
        AuthFactory --> Vue : {success: false}
        Vue --> User : Redirect to Login
    else Token Valid
        API -> API : parseRequestBody()\nChangePasswordRequest.class
        
        API -> Service : changePassword(userId, request)
        activate Service
        
        Service -> Service : Validate input\n- newPassword == confirmPassword
        
        alt Passwords Not Match
            Service --> API : throw AppException\n(PASSWORDS_NOT_MATCH)
            API --> Axios : 400 Bad Request
            Axios --> AuthService : Error
            AuthService --> AuthFactory : {success: false}
            AuthFactory --> Vue : {success: false}
            Vue --> User : Hien thi "Mat khau xac nhan khong khop"
        else Passwords Match
            Service -> Repo : findById(userId)
            activate Repo
            Repo -> DB : SELECT * FROM User WHERE id = ?
            DB --> Repo : User
            Repo --> Service : User entity
            deactivate Repo
            
            Service -> Service : Verify old password\n(compare hash)
            
            alt Old Password Wrong
                Service --> API : throw AppException\n(WRONG_PASSWORD)
                API --> Axios : 400 Bad Request
                Axios --> AuthService : Error
                AuthService --> AuthFactory : {success: false}
                AuthFactory --> Vue : {success: false}
                Vue --> User : Hien thi "Mat khau cu khong dung"
            else Old Password Correct
                Service -> Service : Hash new password
                Service -> Service : user.setPassword(hashedNewPassword)\nuser.setUpdatedDate(now())
                
                Service -> Repo : update(user)
                activate Repo
                Repo -> DB : UPDATE User\nSET password = ?, updatedDate = ?\nWHERE id = ?
                DB --> Repo : Success
                Repo --> Service : Updated
                deactivate Repo
                
                Service --> API : true
                deactivate Service
                
                API --> Axios : 200 OK\n{success: true, message: "Doi mat khau thanh cong"}
                deactivate API
                
                Axios --> AuthService : Response
                deactivate Axios
                
                AuthService --> AuthFactory : {success: true}
                deactivate AuthService
                
                AuthFactory --> Vue : {success: true}
                deactivate AuthFactory
                
                Vue -> Vue : Clear form\nShow success message
                Vue --> User : Hien thi "Doi mat khau thanh cong"
            end
        end
    end
end

deactivate Vue

@enduml
